# SOPs (Standard Operating Procedures)

> ì˜ì‚¬ê²°ì • ë¡œì§ ë ˆì´ì–´ - ë²ˆì—­ íŒŒì´í”„ë¼ì¸ì˜ íŒì • ë° íë¦„ ì œì–´

## ì™œ SOPì¸ê°€?

LLM ê¸°ë°˜ ì‹œìŠ¤í…œì˜ ê³ ì§ˆì ì¸ ë¬¸ì œ:

| ë¬¸ì œ | ì˜í–¥ |
|------|------|
| **ë¹„ê²°ì •ì  ì¶œë ¥** | ê°™ì€ ì…ë ¥ì— ë‹¤ë¥¸ ê²°ê³¼ â†’ ê°ì‚¬ ë¶ˆê°€ |
| **íŒì • ê·¼ê±° ë¶ˆëª…í™•** | "ì™œ ë¦¬ì ?" ì„¤ëª… ì–´ë ¤ì›€ |
| **ì •ì±… ë³€ê²½ ì–´ë ¤ì›€** | í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì‹œ ë¶€ì‘ìš© ì˜ˆì¸¡ ë¶ˆê°€ |

**SOPì˜ í•´ê²°ì±…:**

| íŠ¹ì„± | íš¨ê³¼ |
|------|------|
| **ê²°ì •ë¡ ì ** | ê°™ì€ ì ìˆ˜ â†’ í•­ìƒ ê°™ì€ íŒì • |
| **ê°ì‚¬ ê°€ëŠ¥** | Python ì½”ë“œë¡œ íŒì • ë¡œì§ ëª…ì‹œ |
| **í…ŒìŠ¤íŠ¸ ê°€ëŠ¥** | ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ ì •ì±… ê²€ì¦ |
| **LLM ë¹„ì˜ì¡´** | í‰ê°€ëŠ” LLM, íŒì •ì€ SOP ë¶„ë¦¬ |

---

## ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SOP íë¦„ë„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   [3ê°œ í‰ê°€ ì—ì´ì „íŠ¸]                                                     â”‚
â”‚         â”‚                                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚ EvaluationGate  â”‚ â—„â”€â”€â”€ ì ìˆ˜ ê¸°ë°˜ íŒì •                                â”‚
â”‚   â”‚     SOP         â”‚                                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚            â”‚                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚   â”‚        â”‚        â”‚            â”‚                                      â”‚
â”‚   â–¼        â–¼        â–¼            â–¼                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚ â”‚PASSâ”‚  â”‚BLOCKâ”‚  â”‚REGEN â”‚  â”‚ REJECTED â”‚                                â”‚
â”‚ â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                     â”‚                                                   â”‚
â”‚                     â–¼                                                   â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚               â”‚Regenerationâ”‚                                            â”‚
â”‚               â”‚    SOP     â”‚                                            â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## SOPs vs Skills vs Tools

| êµ¬ë¶„ | ì—­í•  | í˜•íƒœ | ì˜ˆì‹œ | ìƒíƒœ |
|------|------|------|------|------|
| **SOP** | ì˜ì‚¬ê²°ì • ì ˆì°¨ | Python í´ë˜ìŠ¤ | ì ìˆ˜ íŒì • ë¡œì§ | âœ… êµ¬í˜„ë¨ |
| **Tool** | ì‹¤í–‰ ë˜í¼ | Python í•¨ìˆ˜ | ì—ì´ì „íŠ¸ í˜¸ì¶œ | âœ… êµ¬í˜„ë¨ |
| **Skill** | ì§€ì‹/ëŠ¥ë ¥ ì •ì˜ | Markdown (SKILL.md) | ë²ˆì—­ ê°€ì´ë“œë¼ì¸ | ğŸ”® í–¥í›„ ê¸°ëŠ¥ |

### SOP vs Skill ì°¨ì´ì 

| í•­ëª© | SOP | Skill |
|------|-----|-------|
| **ì‹¤í–‰ ì£¼ì²´** | Python ì½”ë“œ | LLM |
| **ê²°ì •ë¡ ì ** | âœ… í•­ìƒ ë™ì¼ ê²°ê³¼ | âŒ ê°€ë³€ì  |
| **ìš©ë„** | ì •ì±…/íŒì • ë¡œì§ | ë„ë©”ì¸ ì§€ì‹/ê°€ì´ë“œë¼ì¸ |
| **í…ŒìŠ¤íŠ¸** | ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ | í”„ë¡¬í”„íŠ¸ í‰ê°€ í•„ìš” |

> **Skills (í–¥í›„ ê¸°ëŠ¥)**: ë„ë©”ì¸ë³„ ë²ˆì—­ ê°€ì´ë“œë¼ì¸, ìŠ¤íƒ€ì¼ ê·œì¹™ ë“±ì„ Markdownìœ¼ë¡œ ì •ì˜í•˜ì—¬ ì—ì´ì „íŠ¸ì— ì£¼ì…í•˜ëŠ” ì§€ì‹ íŒ¨í‚¤ì§€. í˜„ì¬ëŠ” í”„ë¡¬í”„íŠ¸ì— ì§ì ‘ í¬í•¨ë˜ì–´ ìˆìœ¼ë©°, í–¥í›„ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ Skill ëª¨ë“ˆë¡œ ë¶„ë¦¬ ì˜ˆì •.

---

## íŒŒì¼ êµ¬ì¡°

```
sops/
â”œâ”€â”€ __init__.py           # ëª¨ë“ˆ exports
â”œâ”€â”€ README.md             # ì´ ë¬¸ì„œ
â”œâ”€â”€ evaluation_gate.py    # í‰ê°€ ê²Œì´íŠ¸ (í•µì‹¬ íŒì •)
â””â”€â”€ regeneration.py       # ì¬ìƒì„± í”¼ë“œë°± ìˆ˜ì§‘
```

---

## 1. evaluation_gate.py

> **Release Guard** - ë²ˆì—­ ë°œí–‰ ê°€ëŠ¥ ì—¬ë¶€ ìµœì¢… íŒì •

### ì—­í• 

3ê°œ í‰ê°€ ì—ì´ì „íŠ¸(Accuracy, Compliance, Quality)ì˜ ì ìˆ˜ë¥¼ ë¶„ì„í•˜ì—¬
ë²ˆì—­ì„ ë°œí–‰í• ì§€, ì¬ìƒì„±í• ì§€, ì°¨ë‹¨í• ì§€ ê²°ì •í•©ë‹ˆë‹¤.

### íŒì • ê·œì¹™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    íŒì • ì˜ì‚¬ê²°ì • íŠ¸ë¦¬                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   ëª¨ë“  ì—ì´ì „íŠ¸ ì ìˆ˜ = 5?                                     â”‚
â”‚         â”‚                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                              â”‚
â”‚   YES       NO                                              â”‚
â”‚    â”‚         â”‚                                              â”‚
â”‚    â–¼         â–¼                                              â”‚
â”‚  PASS    ì–´ë–¤ ì—ì´ì „íŠ¸ ì ìˆ˜ â‰¤ 2?                              â”‚
â”‚    â”‚              â”‚                                         â”‚
â”‚    â”‚         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                    â”‚
â”‚    â”‚        YES       NO                                    â”‚
â”‚    â”‚         â”‚         â”‚                                    â”‚
â”‚    â”‚         â–¼         â–¼                                    â”‚
â”‚    â”‚      BLOCK    ì—ì´ì „íŠ¸ ê°„ ì ìˆ˜ ì°¨ì´ â‰¥ 3?                 â”‚
â”‚    â”‚         â”‚              â”‚                               â”‚
â”‚    â”‚         â”‚         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                          â”‚
â”‚    â”‚         â”‚        YES       NO                          â”‚
â”‚    â”‚         â”‚         â”‚         â”‚                          â”‚
â”‚    â”‚         â”‚         â–¼         â–¼                          â”‚
â”‚    â”‚         â”‚     REJECTED   ì¬ì‹œë„ ê°€ëŠ¥?                   â”‚
â”‚    â”‚         â”‚    (ë¶ˆì¼ì¹˜)          â”‚                       â”‚
â”‚    â”‚         â”‚         â”‚         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                â”‚
â”‚    â”‚         â”‚         â”‚        YES       NO                â”‚
â”‚    â”‚         â”‚         â”‚         â”‚         â”‚                â”‚
â”‚    â”‚         â”‚         â”‚         â–¼         â–¼                â”‚
â”‚    â”‚         â”‚         â”‚     REGENERATE  REJECTED           â”‚
â”‚    â”‚         â”‚         â”‚         â”‚         â”‚                â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ìš” í´ë˜ìŠ¤

```python
class EvaluationGateConfig:
    pass_threshold: int = 5       # í†µê³¼ ìµœì†Œ ì ìˆ˜ (ëª¨ë“  ì—ì´ì „íŠ¸ 5ì  í•„ìš”)
    fail_threshold: int = 2       # ì°¨ë‹¨ ìµœëŒ€ ì ìˆ˜
    max_regenerations: int = 1    # ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜
    disagreement_threshold: int = 3  # ì—ì´ì „íŠ¸ ë¶ˆì¼ì¹˜ ì„ê³„ê°’

class EvaluationGateSOP:
    def decide(
        agent_results: List[AgentResult],
        attempt_count: int = 1
    ) -> GateDecision
```

### ì¶œë ¥: GateDecision

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `verdict` | Verdict | PASS / BLOCK / REGENERATE / REJECTED |
| `can_publish` | bool | ë°œí–‰ ê°€ëŠ¥ ì—¬ë¶€ |
| `scores` | Dict[str, int] | ì—ì´ì „íŠ¸ë³„ ì ìˆ˜ |
| `reasoning_chains` | Dict | ì—ì´ì „íŠ¸ë³„ í‰ê°€ ê³¼ì • |
| `corrections` | List[dict] | ìˆ˜ì • ì œì•ˆ ëª©ë¡ |
| `agent_agreement_score` | float | ì—ì´ì „íŠ¸ ê°„ ì¼ì¹˜ë„ (0-1) |

---

## 2. regeneration.py

> **Maker-Checker Loop** - ì¬ìƒì„±ì„ ìœ„í•œ í”¼ë“œë°± ìˆ˜ì§‘

### ì—­í• 

ê²½ê³„ ì ìˆ˜(score 3-4) ë°œìƒ ì‹œ ì´ì „ í‰ê°€ì˜ ë¬¸ì œì ì„ ìˆ˜ì§‘í•˜ì—¬
ë²ˆì—­ ì—ì´ì „íŠ¸ê°€ ê°œì„ ëœ ë²ˆì—­ì„ ìƒì„±í•  ìˆ˜ ìˆë„ë¡ í”¼ë“œë°±ì„ í¬ë§·í•©ë‹ˆë‹¤.

### Maker-Checker íŒ¨í„´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MAKER     â”‚                      â”‚   CHECKER   â”‚
â”‚ (Translator)â”‚                      â”‚(3 Evaluators)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                    â”‚
       â”‚  1. ë²ˆì—­ ìƒì„±                       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
       â”‚                                    â”‚
       â”‚                     2. í‰ê°€ + í”¼ë“œë°±â”‚
       â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                    â”‚
       â”‚  3. í”¼ë“œë°± ë°˜ì˜ ì¬ìƒì„±               â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
       â”‚                                    â”‚
```

### ì£¼ìš” í´ë˜ìŠ¤

```python
@dataclass
class RegenerationFeedback:
    previous_issues: List[str]      # ì´ì „ ë¬¸ì œì 
    corrections: List[Correction]   # ìˆ˜ì • ì œì•ˆ
    agent_feedbacks: Dict[str, List[str]]  # ì—ì´ì „íŠ¸ë³„ ë¶„ì„
    triggering_agents: List[str]    # ì¬ìƒì„± ìœ ë°œ ì—ì´ì „íŠ¸
    previous_translation: Optional[str]    # ì´ì „ ë²ˆì—­

class RegenerationSOP:
    def collect_feedback(
        agent_results: List[AgentResult]
    ) -> RegenerationFeedback

    def format_feedback_for_prompt(
        feedback: RegenerationFeedback,
        language: str = "ko"
    ) -> str
```

### ì¶œë ¥ ì˜ˆì‹œ (í”„ë¡¬í”„íŠ¸ ì£¼ì…ìš©)

```xml
<previous_feedback>
ì´ì „ ë²ˆì—­ì—ì„œ ë‹¤ìŒ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:

**ë°œê²¬ëœ ë¬¸ì œ:**
1. ìš©ì–´ì§‘ ë¯¸ì ìš©: "ABC Cloud" â†’ "ABC í´ë¼ìš°ë“œ"ë¡œ ë²ˆì—­ë¨
2. ë‰˜ì•™ìŠ¤ ì†ì‹¤: "ë°˜ë“œì‹œ"ì˜ ê°•ì¡°ê°€ ì•½í™”ë¨

**ìˆ˜ì • ì œì•ˆ:**
- 'ABC í´ë¼ìš°ë“œ' â†’ 'ABC Cloud'
  ì‚¬ìœ : ë¸Œëœë“œëª…ì€ ë²ˆì—­í•˜ì§€ ì•ŠìŒ

ìœ„ ë¬¸ì œì ì„ í”¼í•˜ì—¬ ìƒˆë¡œìš´ ë²ˆì—­ì„ ìƒì„±í•˜ì„¸ìš”.
</previous_feedback>
```

---

## ì‚¬ìš© ì˜ˆì‹œ

```python
from sops import EvaluationGateSOP, RegenerationSOP

# 1. í‰ê°€ ê²°ê³¼ë¡œ íŒì •
gate_sop = EvaluationGateSOP()
decision = gate_sop.decide(agent_results, attempt_count=1)

# 2. íŒì •ì— ë”°ë¥¸ ë¶„ê¸°
if decision.verdict == Verdict.PASS:
    # ë°œí–‰ ê°€ëŠ¥
    publish(unit, translation)

elif decision.verdict == Verdict.REGENERATE:
    # í”¼ë“œë°± ìˆ˜ì§‘ í›„ ì¬ìƒì„±
    regen_sop = RegenerationSOP()
    feedback = regen_sop.collect_feedback(agent_results)
    prompt_addition = regen_sop.format_feedback_for_prompt(feedback)
    # â†’ ë²ˆì—­ ì—ì´ì „íŠ¸ì— prompt_addition ì£¼ì…í•˜ì—¬ ì¬ìƒì„±

elif decision.verdict in (Verdict.BLOCK, Verdict.REJECTED):
    # ê±°ë¶€
    logger.error(f"Translation rejected: {decision.message}")
```

---

## í…ŒìŠ¤íŠ¸

```bash
# SOP ê¸°ë³¸ í…ŒìŠ¤íŠ¸
uv run python -c "
import sys
sys.path.insert(0, '/path/to/01_explainable_translate_agent')

from sops import EvaluationGateSOP
from src.models.agent_result import AgentResult

gate = EvaluationGateSOP()

# ëª¨ë‘ í†µê³¼ (ëª¨ë“  ì ìˆ˜ 5)
results = [
    AgentResult(agent_name='accuracy', score=5, verdict='pass', reasoning_chain=[]),
    AgentResult(agent_name='compliance', score=5, verdict='pass', reasoning_chain=[]),
    AgentResult(agent_name='quality', score=5, verdict='pass', reasoning_chain=[]),
]
decision = gate.decide(results)
print(f'Verdict: {decision.verdict.value}')  # pass
print(f'Can publish: {decision.can_publish}')  # True

# ì¬ìƒì„± í•„ìš” (5,5,4 â†’ í•˜ë‚˜ë¼ë„ 5 ë¯¸ë§Œ)
results = [
    AgentResult(agent_name='accuracy', score=5, verdict='pass', reasoning_chain=[]),
    AgentResult(agent_name='compliance', score=5, verdict='pass', reasoning_chain=[]),
    AgentResult(agent_name='quality', score=4, verdict='regenerate', reasoning_chain=[]),
]
decision = gate.decide(results)
print(f'Verdict: {decision.verdict.value}')  # regenerate
"
```

---

## ì„¤ì • ì»¤ìŠ¤í„°ë§ˆì´ì§•

```python
from sops import EvaluationGateSOP, EvaluationGateConfig

# ê¸°ë³¸ ì„¤ì • (í˜„ì¬ ì ìš©)
default_config = EvaluationGateConfig(
    pass_threshold=5,      # ëª¨ë“  ì—ì´ì „íŠ¸ 5ì  í•„ìš”
    fail_threshold=2,      # 2ì  ì´í•˜ ì¦‰ì‹œ ì°¨ë‹¨
    max_regenerations=1,   # ìµœëŒ€ 1íšŒ ì¬ì‹œë„
    disagreement_threshold=3  # 3ì  ì°¨ì´ ë¶ˆì¼ì¹˜ë¡œ ê°„ì£¼
)

# ì»¤ìŠ¤í…€ ì„¤ì • ì˜ˆì‹œ (ë” ê´€ëŒ€í•œ ê¸°ì¤€)
lenient_config = EvaluationGateConfig(
    pass_threshold=4,      # 4ì  ì´ìƒ í†µê³¼
    fail_threshold=2,
    max_regenerations=3,   # ìµœëŒ€ 3íšŒ ì¬ì‹œë„
    disagreement_threshold=3
)

gate = EvaluationGateSOP(config=default_config)
```
